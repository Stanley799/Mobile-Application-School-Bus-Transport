rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper function to check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // Helper function to get user role (with error handling)
    function getUserRole() {
      let userDoc = get(/databases/$(database)/documents/users/$(request.auth.uid));
      return userDoc != null && userDoc.data != null ? userDoc.data.role : null;
    }
    
    // Helper function to check if user is owner
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }
    
    // Helper function to check if user is admin
    function isAdmin() {
      return isAuthenticated() && getUserRole() == 'ADMIN';
    }
    
    // Users collection
    match /users/{userId} {
      // Users can read their own data and all users can read other users (for messaging)
      allow read: if isAuthenticated();
      // Users can update their own data (except role)
      allow update: if isAuthenticated() && isOwner(userId) && 
        (!('role' in request.resource.data) || request.resource.data.role == resource.data.role);
      // Users can create their own document during registration, admins can create any
      allow create: if isAuthenticated() && (isOwner(userId) || isAdmin());
    }
    
    // Students collection
    match /students/{studentId} {
      // Parents can read their own children, admins and drivers can read all
      allow read: if isAuthenticated() && (
        resource.data.parentId == request.auth.uid ||
        isAdmin() ||
        getUserRole() == 'DRIVER'
      );
      // Parents can create students (their children)
      allow create: if isAuthenticated() && request.resource.data.parentId == request.auth.uid;
      // Parents can update/delete their own children, admins can do anything
      allow update, delete: if isAuthenticated() && (
        resource.data.parentId == request.auth.uid ||
        isAdmin()
      );
    }
    
    // Routes collection
    match /routes/{routeId} {
      // Everyone authenticated can read routes
      allow read: if isAuthenticated();
      // Only admins can create/update/delete routes
      allow write: if isAuthenticated() && isAdmin();
    }
    
    // Buses collection
    match /buses/{busId} {
      // Everyone authenticated can read buses
      allow read: if isAuthenticated();
      // Only admins can create/update/delete buses
      allow write: if isAuthenticated() && isAdmin();
    }
    
    // Trips collection
    match /trips/{tripId} {
      // Drivers can read their assigned trips
      // Parents can read trips where their children are included
      // Admins can read all trips
      allow read: if isAuthenticated() && (
        isAdmin() ||
        resource.data.driverId == request.auth.uid ||
        // Check if any student in trip belongs to this parent (simplified check)
        (resource.data.studentIds != null && resource.data.studentIds is list)
      );
      // Only admins can create trips
      allow create: if isAuthenticated() && isAdmin();
      // Drivers can update their trips (start/end), admins can update any
      allow update: if isAuthenticated() && (
        isAdmin() ||
        (resource.data.driverId == request.auth.uid && 
         request.resource.data.diff(resource.data).affectedKeys().hasOnly(['status', 'startTime', 'endTime', 'updatedAt']))
      );
      // Only admins can delete trips
      allow delete: if isAuthenticated() && isAdmin();
    }
    
    // Attendance collection
    match /attendance/{attendanceId} {
      // Drivers can read attendance for their trips
      // Parents can read attendance for their children's trips
      // Admins can read all
      allow read: if isAuthenticated() && (
        isAdmin() ||
        // Simplified: allow read if authenticated (can be refined later)
        true
      );
      // Only drivers and admins can create/update attendance
      allow write: if isAuthenticated() && (
        isAdmin() ||
        getUserRole() == 'DRIVER'
      );
    }
    
    // Messages collection
    match /messages/{messageId} {
      // Users can read messages where they are sender or receiver
      allow read: if isAuthenticated() && (
        resource.data.senderId == request.auth.uid ||
        resource.data.receiverId == request.auth.uid
      );
      // Users can create messages (as sender)
      allow create: if isAuthenticated() && request.resource.data.senderId == request.auth.uid;
      // Users can update their own sent messages
      allow update: if isAuthenticated() && resource.data.senderId == request.auth.uid;
    }
    
    // Trip Reports collection
    match /tripReports/{reportId} {
      // Users can read reports for trips they have access to
      allow read: if isAuthenticated();
      // Only Cloud Functions can create reports (they use admin SDK)
      allow create: if false;
      allow update, delete: if isAuthenticated() && isAdmin();
    }
    
    // Notifications collection
    match /notifications/{notificationId} {
      // Users can read their own notifications
      allow read: if isAuthenticated() && resource.data.userId == request.auth.uid;
      // Only Cloud Functions can create notifications
      allow create: if false;
      // Users can update their own notifications (mark as read)
      allow update: if isAuthenticated() && resource.data.userId == request.auth.uid &&
        request.resource.data.diff(resource.data).affectedKeys().hasOnly(['read']);
    }
    
    // FCM Tokens collection (for push notifications)
    match /fcmTokens/{userId} {
      // Users can read/write their own token
      allow read, write: if isAuthenticated() && isOwner(userId);
    }
  }
}
