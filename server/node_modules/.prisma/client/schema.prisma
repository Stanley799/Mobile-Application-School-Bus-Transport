datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

// Enums
enum grade_enum {
  PP1
  PP2
  Grade_1
  Grade_2
  Grade_3
  Grade_4
  Grade_5
  Grade_6
}

// Table: users
model users {
  id                Int             @id @default(autoincrement())
  name              String?         @map("name")
  email             String          @unique
  password          String
  phone             String          @unique
  role              String
  loginstatus       Boolean?        @default(false)
  administrators    administrators?
  drivers           drivers?
  parents           parents?
  message_sent      message[]       @relation("sender")
  message_received  message[]       @relation("receiver")
  attendance_marked attendance[]    @relation("marked_by")
}

// Table: administrators
model administrators {
  id           Int            @id @default(autoincrement())
  user_id      Int            @unique
  admin_fname  String
  admin_lname  String
  user         users          @relation(fields: [user_id], references: [id], onDelete: Cascade)
  instructions instructions[]
}

// Table: drivers
model drivers {
  id           Int    @id @default(autoincrement())
  user_id      Int    @unique
  driver_fname String
  driver_lname String
  user         users  @relation(fields: [user_id], references: [id], onDelete: Cascade)
  bus          bus?
  trip         trip[]
}

// Table: parents
model parents {
  id           Int        @id @default(autoincrement())
  user_id      Int        @unique
  parent_fname String
  parent_lname String
  address      String?
  user         users      @relation(fields: [user_id], references: [id], onDelete: Cascade)
  students     students[]
}

// Table: students
model students {
  id                   Int                    @id @default(autoincrement())
  student_fname        String
  student_lname        String
  stream               String?
  admission            Int                    @unique
  parent_id            Int?
  grade                grade_enum?
  parent               parents?               @relation(fields: [parent_id], references: [id], onDelete: SetNull)
  attendance           attendance[]
  trip_attendance_list trip_attendance_list[]
}

// Table: bus
model bus {
  id           Int      @id @default(autoincrement())
  number_plate String   @unique
  status       String
  capacity     Int?
  driver_id    Int?     @unique
  bus_name     String?
  driver       drivers? @relation(fields: [driver_id], references: [id], onDelete: SetNull)
  trip         trip[]
}

// Table: route
model route {
  id             Int     @id @default(autoincrement())
  route_name     String
  estimated_time String
  start_location String?
  end_location   String?
  trip           trip[]
}

// Table: trip
model trip {
  id                   Int                    @id @default(autoincrement())
  trip_id              String                 @unique
  start                String? // time, use String
  stop                 String? // time, use String
  trip_date            DateTime
  bus_id               Int
  route_id             Int
  driver_id            Int
  status               String?
  trip_name            String
  departure_time       String?
  arrival_time         String?
  bus_name             String?
  route_name           String?
  driver_name          String?
  bus                  bus                    @relation(fields: [bus_id], references: [id], onDelete: Cascade)
  route                route                  @relation(fields: [route_id], references: [id], onDelete: Cascade)
  driver               drivers                @relation(fields: [driver_id], references: [id], onDelete: Cascade)
  trip_attendance_list trip_attendance_list[]
  attendance           attendance[]
  instructions         instructions[]
  report               report[]
}

// Table: trip_attendance_list
model trip_attendance_list {
  trip_id    Int
  student_id Int
  trip       trip     @relation(fields: [trip_id], references: [id], onDelete: Cascade)
  student    students @relation(fields: [student_id], references: [id], onDelete: Cascade)

  @@id([trip_id, student_id])
}

// Table: attendance
model attendance {
  id         Int      @id @default(autoincrement())
  trip_id    Int
  student_id Int
  status     String?
  timestamp  DateTime @default(now())
  marked_by  Int?
  trip       trip     @relation(fields: [trip_id], references: [id], onDelete: Cascade)
  student    students @relation(fields: [student_id], references: [id], onDelete: Cascade)
  markedBy   users?   @relation("marked_by", fields: [marked_by], references: [id])

  @@unique([trip_id, student_id])
}

// Table: message
model message {
  message_id  Int      @id @default(autoincrement())
  sender_id   Int
  receiver_id Int
  content     String
  timestamp   DateTime @default(now())
  sender      users    @relation("sender", fields: [sender_id], references: [id], onDelete: Cascade)
  receiver    users    @relation("receiver", fields: [receiver_id], references: [id], onDelete: Cascade)
}

// Table: instructions
model instructions {
  id         Int            @id @default(autoincrement())
  trip_id    Int
  admin_id   Int
  message    String
  created_at DateTime       @default(now())
  trip       trip           @relation(fields: [trip_id], references: [id], onDelete: Cascade)
  admin      administrators @relation(fields: [admin_id], references: [id], onDelete: Cascade)
}

// Table: report
model report {
  id            Int      @id @default(autoincrement())
  report_id     String   @unique
  parent_report String?
  driver_report String?
  admin_report  String?
  trip_id       Int
  created_at    DateTime @default(now())
  trip          trip     @relation(fields: [trip_id], references: [id], onDelete: Cascade)
}
